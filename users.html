<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>إدارة المستخدمين - لوحة التحكم</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="assets/css/main.css">
</head>
<body>
    <div class="wrapper">
        <nav id="sidebar"></nav>

        <div id="content">
            <nav class="navbar navbar-expand-lg navbar-light" id="navbar"></nav>

            <div class="container-fluid">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2 class="fw-bold text-primary">إدارة المستخدمين</h2>
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#userModal" onclick="resetForm()">
                        <i class="fas fa-plus me-2"></i> إضافة مستخدم
                    </button>
                </div>

                <div class="card">
                    <div class="card-header bg-white">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">قائمة المستخدمين</h5>
                            <div class="d-flex gap-2">
                                <select class="form-select w-auto" id="roleFilter" onchange="renderUsers()">
                                    <option value="all">كل الأدوار</option>
                                    <option value="admin">مسؤول</option>
                                    <option value="doctor">طبيب</option>
                                    <option value="patient">مريض</option>
                                </select>
                                <select class="form-select w-auto" id="statusFilter" onchange="renderUsers()">
                                    <option value="all">كل الحالات</option>
                                    <option value="active">نشط</option>
                                    <option value="inactive">معطل</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover" id="usersTable">
                                <thead>
                                    <tr>
                                        <th>الاسم</th>
                                        <th>البريد الإلكتروني</th>
                                        <th>الدور</th>
                                        <th>الحالة</th>
                                        <th>الاشتراك</th>
                                        <th>الإجراءات</th>
                                    </tr>
                                </thead>
                                <tbody id="usersTableBody">
                                    <!-- Injected by JS -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- User Modal -->
    <div class="modal fade" id="userModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalTitle">إضافة مستخدم جديد</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="userForm">
                        <input type="hidden" id="userId">
                        <div class="mb-3">
                            <label class="form-label">الاسم الكامل</label>
                            <input type="text" class="form-control" id="userName" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">البريد الإلكتروني</label>
                            <input type="email" class="form-control" id="userEmail" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">كلمة المرور</label>
                            <input type="password" class="form-control" id="userPassword" placeholder="اتركه فارغاً للإبقاء على الحالية">
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">الدور</label>
                                <select class="form-select" id="userRole" required onchange="toggleFields()">
                                    <option value="admin">مسؤول (Admin)</option>
                                    <option value="doctor">طبيب (Doctor)</option>
                                    <option value="patient">مريض (Patient)</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">الحالة</label>
                                <select class="form-select" id="userStatus">
                                    <option value="active">نشط</option>
                                    <option value="inactive">معطل</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- Patient Specific Fields -->
                        <div id="patientFields" style="display: none;">
                            <div class="mb-3">
                                <label class="form-label">نوع الاشتراك</label>
                                <select class="form-select" id="userType">
                                    <option value="normal">عادي</option>
                                    <option value="subscribed">مشترك (Premium)</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">الطبيب المعالج</label>
                                <select class="form-select" id="userDoctor">
                                    <option value="">اختر الطبيب...</option>
                                    <!-- Injected by JS -->
                                </select>
                            </div>
                        </div>

                        <button type="submit" class="btn btn-primary w-100">حفظ</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="assets/js/api.js"></script>
    <script src="assets/js/app.js"></script>
    <script src="assets/js/layout.js"></script>
    <script>
        let userModal;
        
        document.addEventListener('DOMContentLoaded', () => {
            Layout.init('users');
            userModal = new bootstrap.Modal(document.getElementById('userModal'));
            renderUsers();
            loadDoctors();
        });

        async function loadDoctors() {
            try {
                const response = await ApiService.doctors.getAll();
                const doctors = response.data || response;
                const select = document.getElementById('userDoctor');
                select.innerHTML = '<option value="">اختر الطبيب...</option>' + 
                    doctors.map(d => `<option value="${d.id}">${d.name}</option>`).join('');
            } catch (error) {
                console.error('Failed to load doctors', error);
            }
        }

        function toggleFields() {
            const role = document.getElementById('userRole').value;
            document.getElementById('patientFields').style.display = role === 'patient' ? 'block' : 'none';
        }

        async function renderUsers() {
            const roleFilter = document.getElementById('roleFilter').value;
            const statusFilter = document.getElementById('statusFilter').value;
            
            const params = {};
            if (roleFilter !== 'all') params.role = roleFilter;
            if (statusFilter !== 'all') params.status = statusFilter;

            try {
                const response = await ApiService.users.getAll(params);
                const users = response.data || response;
                const tbody = document.getElementById('usersTableBody');
                
                tbody.innerHTML = users.map(user => `
                    <tr>
                        <td>
                            <div class="d-flex align-items-center">
                                <div class="bg-light rounded-circle p-2 me-2 text-primary">
                                    <i class="fas fa-user"></i>
                                </div>
                                <div>
                                    <div class="fw-bold">${user.name}</div>
                                    <small class="text-muted">ID: #${user.id}</small>
                                </div>
                            </div>
                        </td>
                        <td>${user.email}</td>
                        <td><span class="badge bg-${getRoleColor(user.role)}-light text-${getRoleColor(user.role)}">${getRoleName(user.role)}</span></td>
                        <td>
                            <span class="badge bg-${user.status === 'active' ? 'success' : 'danger'}-light text-${user.status === 'active' ? 'success' : 'danger'}">
                                ${user.status === 'active' ? 'نشط' : 'معطل'}
                            </span>
                        </td>
                        <td>
                            ${user.role === 'patient' ? 
                                `<span class="badge bg-${user.type === 'subscribed' ? 'warning' : 'secondary'}-light text-${user.type === 'subscribed' ? 'warning' : 'secondary'}">
                                    ${user.type === 'subscribed' ? 'Premium' : 'مجاني'}
                                </span>` : '-'
                            }
                        </td>
                        <td>
                            <a href="user-details.html?id=${user.id}" class="btn btn-sm btn-light text-info" title="التفاصيل">
                                <i class="fas fa-eye"></i>
                            </a>
                            <button class="btn btn-sm btn-light text-primary" onclick="editUser(${user.id})">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-light text-danger" onclick="deleteUser(${user.id})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('Failed to load users', error);
                document.getElementById('usersTableBody').innerHTML = '<tr><td colspan="6" class="text-center text-danger">فشل تحميل البيانات</td></tr>';
            }
        }

        function getRoleColor(role) {
            return { admin: 'primary', doctor: 'info', patient: 'success' }[role] || 'secondary';
        }

        function getRoleName(role) {
            return { admin: 'مسؤول', doctor: 'طبيب', patient: 'مريض' }[role] || role;
        }

        function resetForm() {
            document.getElementById('userForm').reset();
            document.getElementById('userId').value = '';
            document.getElementById('modalTitle').innerText = 'إضافة مستخدم جديد';
        }

        async function editUser(id) {
            try {
                const response = await ApiService.users.get(id);
                const user = response.data || response;
                
                document.getElementById('userId').value = user.id;
                document.getElementById('userName').value = user.name;
                document.getElementById('userEmail').value = user.email;
                document.getElementById('userRole').value = user.role;
                document.getElementById('userStatus').value = user.status;
                
                // Patient specific
                if (user.role === 'patient') {
                    document.getElementById('userType').value = user.type || 'normal';
                    document.getElementById('userDoctor').value = user.doctorId || '';
                }
                
                toggleFields();
                document.getElementById('modalTitle').innerText = 'تعديل مستخدم';
                
                userModal.show();
            } catch (error) {
                console.error('Failed to load user details', error);
                showToast('فشل تحميل بيانات المستخدم', 'error');
            }
        }

        async function deleteUser(id) {
            if (confirm('هل أنت متأكد من حذف هذا المستخدم؟')) {
                try {
                    await ApiService.users.delete(id);
                    renderUsers();
                    showToast('تم حذف المستخدم بنجاح');
                } catch (error) {
                    console.error('Failed to delete user', error);
                    showToast('فشل حذف المستخدم', 'error');
                }
            }
        }

        document.getElementById('userForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('userId').value;
            const role = document.getElementById('userRole').value;
            
            const data = {
                name: document.getElementById('userName').value,
                email: document.getElementById('userEmail').value,
                role: role,
                status: document.getElementById('userStatus').value
            };
            
            if (role === 'patient') {
                data.type = document.getElementById('userType').value;
                data.doctorId = document.getElementById('userDoctor').value;
            }
            
            const password = document.getElementById('userPassword').value;
            if (password) data.password = password;

            try {
                if (id) {
                    await ApiService.users.update(id, data);
                    showToast('تم تحديث البيانات بنجاح');
                } else {
                    if (!password) data.password = '123456'; // Default password if not provided
                    await ApiService.users.create(data);
                    showToast('تم إضافة المستخدم بنجاح');
                }
                
                userModal.hide();
                renderUsers();
            } catch (error) {
                console.error('Failed to save user', error);
                showToast('فشل حفظ البيانات', 'error');
            }
        });
    </script>
</body>
</html>
